--Create my own database and warehouse 
CREATE DATABASE IMT577_DW_TOMMY_HUYNH;
CREATE WAREHOUSE IMT577_DW_TOMMY_HUYNH;

USE WAREHOUSE IMT577_DW_TOMMY_HUYNH;
USE DATABASE IMT577_DW_TOMMY_HUYNH;
        
-- Create Staging Per file location and credentials provided in Azure Blob Storage
--Stage 1: Channel
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".CHANNEL_STAGE URL = 'azure://sp72storage.blob.core.windows.net/channel' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 2: ChannelCategory
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".CHANNELCATEGORY_STAGE URL = 'azure://sp72storage.blob.core.windows.net/channelcategory' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 3: Customer
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".CUSTOMER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/customer' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 4: Product
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".PRODUCT_STAGE URL = 'azure://sp72storage.blob.core.windows.net/product' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 5:ProductCategory
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".PRODUCTCATEGORY_STAGE URL = 'azure://sp72storage.blob.core.windows.net/productcategory' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 6:ProductType
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".PRODUCTTYPE_STAGE URL = 'azure://sp72storage.blob.core.windows.net/producttype' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 7:Reseller
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".RESELLER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/reseller' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 8:SalesDetail
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".SALES_DETAILS_STAGE URL = 'azure://sp72storage.blob.core.windows.net/salesdetail' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 9:SalesHeader
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".SALES_HEADER_STAGE URL = 'azure://sp72storage.blob.core.windows.net/salesheader' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 10:Store
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".STORE_STAGE URL = 'azure://sp72storage.blob.core.windows.net/store' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 11:TargetData_ChannelResellerAndStore	
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".TAGETDATA_CHANNELRESELLER_STORE_STAGE URL = 'azure://sp72storage.blob.core.windows.net/targetdatachannel' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');
--Stage 12:TargetData_Product	
CREATE STAGE "IMT577_DW_TOMMY_HUYNH"."PUBLIC".TARGETDATA_PRODUCT_STAGE URL = 'azure://sp72storage.blob.core.windows.net/targetdataproduct' CREDENTIALS = (AZURE_SAS_TOKEN = '?sv=2020-08-04&ss=bfqt&srt=sco&sp=rwdlacupitfx&se=2026-04-23T10:59:43Z&st=2022-04-23T02:59:43Z&spr=https,http&sig=uWPc88FzwC98%2BdzbqdTHprs2ON%2FhAzK7m2Hrig8w9G8%3D');

-- Per demo from lecture, we need to create a file format to describe the format of the file to be imported
CREATE OR REPLACE FILE FORMAT CSV_SKIP_HEADER
type = 'CSV'
field_delimiter = ','
FIELD_OPTIONALLY_ENCLOSED_BY = '"'
skip_header = 1;

-- Create Tables
-- Table 1: Channel
create or replace TABLE CHANNEL (
	CHANNELID NUMBER(38,0),
    CHANNELCATEGORYID NUMBER(38,0),
    CHANNEL VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
--**the data type of CREATEDDATE and MODIFIEDDATE should be in DATE or TIMESTAMP (e.g. 1/1/13 20:54'), but in Azure Blob they both show STRING (VARCHAR(255)) type
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CHANNEL"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CHANNEL_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - P NUMBER(38,0)ASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CHANNEL" ;


-- Table 3: Customer
create or replace TABLE CUSTOMER (
    CUSTOMERID VARCHAR(255), --Surrogate Primary Key
    SUBSEGMENTID NUMBER(38,0),
    FIRSTNAME VARCHAR(255),
    LASTNAME VARCHAR(255),
    GENDER VARCHAR(255),
    EMAILADDRESS VARCHAR(255),
    ADDRESS VARCHAR(255),
    CITY VARCHAR(255),
    STATEPROVINCE VARCHAR(255),
    COUNTRY VARCHAR(255),
    POSTALCODE VARCHAR(255),
    PHONENUMBER VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CUSTOMER"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CUSTOMER_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CUSTOMER" ;

-- Table 3: Product
create or replace TABLE PRODUCT (
    PRODUCTID NUMBER(38,0),
    PRODUCTTYPEID NUMBER(38,0),
    PRODUCT VARCHAR(255),
    COLOR VARCHAR(255),
    STYLE VARCHAR(255),
    UNITOFMEASUREID NUMBER(38,0),
    WEIGHT NUMBER(38,0),
    PRICE NUMBER(38,0),
    COST NUMBER(38,0),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255),
  WHOLESALEPRICE NUMBER(38,0)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT" ;

-- Table 4: Product Category
create or replace TABLE PRODUCT_CATEGORY (
    PRODUCTCATEGORYID NUMBER(38,0),
    PRODUCTCATEGORY VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_CATEGORY"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCTCATEGORY_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_CATEGORY" ;

--Table 5: Product Type	
create or replace TABLE PRODUCT_TYPE (
    PRODUCTTYPEID NUMBER(38,0),
    PRODUCTCATEGORYID NUMBER(38,0),
    PRODUCTTYPE VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_TYPE"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCTTYPE_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_TYPE" ;

--Table 6: Product Type	
create or replace TABLE PRODUCT_TYPE (
    PRODUCTTYPEID NUMBER(38,0),
    PRODUCTCATEGORYID NUMBER(38,0),
    PRODUCTTYPE VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_TYPE_STAGE"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCTTYPE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."PRODUCT_TYPE" ;

--Table 7: Reseller	
create or replace TABLE RESELLER (
    RESELLERID  VARCHAR(255), --surrogate key
    CONTACT VARCHAR(255),
    EMAILADDRESS VARCHAR(255),
    ADDRESS VARCHAR(255),
    CITY VARCHAR(255),
    STATEPROVINCE VARCHAR(255),
    COUNTRY VARCHAR(255),
    POSTALCODE VARCHAR(255),
    PHONENUMBER VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255),
    RESELLERNAME VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."RESELLER"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."RESELLER_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."RESELLER" ;

--Table 8: Sales Details
create or replace TABLE SALES_DETAILS (
    SALESDETAILID NUMBER(38,0),
    SALESHEADERID NUMBER(38,0),
    PRODUCTID NUMBER(38,0),
    SALESQUANTITY NUMBER(38,0),
    SALESAMOUNT NUMBER(38,0),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_DETAILS"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_DETAILS_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_DETAILS";


--Table 9: Sales Header
create or replace TABLE SALES_HEADER (
    SALESHEADERID NUMBER(38,0),
    DATE DATE,
    CHANNELID NUMBER(38,0),
    STOREID NUMBER(38,0),
    CUSTOMERID VARCHAR(255), --surrogate key
    RESELLERID VARCHAR(255), --surrogate key
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_HEADER"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_HEADER_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."SALES_HEADER";

--Table 10: Store
create or replace TABLE STORE (
    STOREID NUMBER(38,0),
    SUBSEGMENTID NUMBER(38,0),
    STORENUMBER NUMBER(38,0),
    STOREMANAGER VARCHAR(255),
    ADDRESS VARCHAR(255),
    CITY VARCHAR(255),
    STATEPROVINCE VARCHAR(255),
    COUNTRY VARCHAR(255),
    POSTALCODE VARCHAR(255),
    PHONENUMBER VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."STORE"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."STORE_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."STORE";

--Table 11: Target Data Channel Reseller and Store	
create or replace TABLE TAGETDATA_CHANNEL_RESELLER_STORE (
    YEAR NUMBER(38,0),
    CHANNELNAME VARCHAR(255),
    TARGETNAME VARCHAR(255),
     TARGETSALESAMOUNT NUMBER(38,0)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TAGETDATA_CHANNEL_RESELLER_STORE"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TAGETDATA_CHANNELRESELLER_STORE_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TAGETDATA_CHANNEL_RESELLER_STORE";

--Table 12: Target Data Product	
create or replace TABLE TAGETDATA_PRODUCT (
    PRODUCTID  NUMBER(38,0),
    PRODUCT VARCHAR(255),
    YEAR NUMBER(38,0),
     SALESQUANTITYTARGET  NUMBER(38,0)
);
--Copy data from stage to Table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TAGETDATA_PRODUCT"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TARGETDATA_PRODUCT_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--Check the loaded data - PASS
SELECT * FROM "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."TAGETDATA_PRODUCT";

--Table 2: Channel Category
create or replace TABLE CHANNELCATEGORY_STAGE (
    CHANNELCATEGORYID NUMBER(38,0),
    CHANNELCATEGORY VARCHAR(255),
    CREATEDDATE VARCHAR(255),
   CREATEDBY VARCHAR(255),
   MODIFIEDDATE VARCHAR(255),
  MODIFIEDBY VARCHAR(255));
--copy data from stage to table
COPY INTO "IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CHANNELCATEGORY_STAGE"  FROM '@"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CHANNELCATEGORY_STAGE"' 
FILE_FORMAT = '"IMT577_DW_TOMMY_HUYNH"."PUBLIC"."CSV_SKIP_HEADER"' ON_ERROR ='ABORT_STATEMENT' 
PURGE = FALSE;
--test data load - PASS
select * from CHANNELCATEGORY_STAGE;